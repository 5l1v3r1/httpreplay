#!/usr/bin/env python
# Copyright (C) 2015 Jurriaan Bremer <jbr@cuckoo.sh>
# This file is part of HTTPReplay - http://jbremer.org/httpreplay/
# See the file 'LICENSE' for copying permission.

import argparse
import logging

import httpreplay.cobweb
import httpreplay.reader
import httpreplay.smegma
import httpreplay.test

from httpreplay.cut import http_handler

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("pcapfile", type=str, help="PCAP file")
    args = parser.parse_args()

    logging.basicConfig()

    handlers = {
        80: http_handler(),
        # 443: httpreplay.smegma.TLSStream(httpreplay.cobweb.HttpProtocol()),
    }

    if args.pcapfile == "test":
        httpreplay.test.test_suite()

    reader = httpreplay.reader.PcapReader(args.pcapfile)
    reader.tcp = httpreplay.smegma.TCPPacketStreamer(reader, handlers)

    for s, ts, sent, recv in reader.process():
        print s, ts, sent.uri
